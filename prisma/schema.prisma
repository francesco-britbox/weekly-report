generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  password               String
  name                   String
  permissionLevel        PermissionLevel         @default(view)
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  isSuperUser            Boolean                 @default(false)
  invitationSentAt       DateTime?
  passwordSetAt          DateTime?
  deliveryManagerVendors DeliveryManagerVendor[]
  password_reset_tokens  password_reset_tokens[]
  user_groups            user_groups[]

  @@index([email])
  @@index([isActive])
  @@index([isSuperUser])
  @@index([permissionLevel])
  @@map("users")
}

model Vendor {
  id                     String                  @id @default(cuid())
  name                   String
  address                String?
  location               String?
  serviceDescription     String?
  status                 VendorStatus            @default(active)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  contractEndDate        DateTime?               @db.Date
  contractStartDate      DateTime?               @db.Date
  contracts              contracts[]
  deliveryManagerVendors DeliveryManagerVendor[]
  invoices               invoices[]
  rate_cards             rate_cards[]
  team_members           team_members[]
  vendor_documents       vendor_documents[]
  raidItems              VendorRaidItem[]
  resources              VendorResource[]
  vendor_tags            vendor_tags[]
  timeline               VendorTimeline[]
  weeklyReports          WeeklyReport[]

  @@index([name])
  @@index([status])
  @@index([createdAt])
  @@map("vendors")
}

model DeliveryManagerVendor {
  id        String   @id @default(cuid())
  userId    String
  vendorId  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([userId, vendorId])
  @@index([userId])
  @@index([vendorId])
  @@map("delivery_manager_vendors")
}

model WeeklyReport {
  id           String                    @id @default(cuid())
  vendorId     String
  weekStart    DateTime                  @db.Date
  ragStatus    String?                   @db.VarChar(10)
  status       String                    @default("draft") @db.VarChar(20)
  submittedAt  DateTime?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  achievements WeeklyReportAchievement[]
  focusItems   WeeklyReportFocus[]
  vendor       Vendor                    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, weekStart])
  @@index([vendorId, weekStart])
  @@map("weekly_reports")
}

model WeeklyReportAchievement {
  id          String       @id @default(cuid())
  reportId    String
  description String
  status      String?      @db.VarChar(20)
  isFromFocus Boolean      @default(false)
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  report      WeeklyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@map("weekly_report_achievements")
}

model WeeklyReportFocus {
  id            String       @id @default(cuid())
  reportId      String
  description   String
  isCarriedOver Boolean      @default(false)
  sortOrder     Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  report        WeeklyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@map("weekly_report_focus")
}

model VendorTimeline {
  id        String   @id @default(cuid())
  vendorId  String
  date      String   @db.VarChar(50)
  title     String
  status    String   @db.VarChar(20)
  platforms String[]
  features  String[]
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@map("vendor_timelines")
}

model VendorRaidItem {
  id          String   @id @default(cuid())
  vendorId    String
  type        String   @db.VarChar(20)
  area        String
  description String
  impact      String   @db.VarChar(10)
  owner       String?
  ragStatus   String   @db.VarChar(10)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@map("vendor_raid_items")
}

model VendorResource {
  id          String   @id @default(cuid())
  vendorId    String
  type        String   @db.VarChar(20)
  name        String
  description String?
  url         String
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@map("vendor_resources")
}

model ai_api_configs {
  id              String    @id
  provider        String    @unique @db.VarChar(50)
  encryptedApiKey String
  isEnabled       Boolean   @default(true)
  defaultModel    String?   @db.VarChar(100)
  usageCount      Int       @default(0)
  lastUsedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  lastTestMessage String?
  lastTestStatus  String?   @db.VarChar(20)
  lastTestedAt    DateTime?

  @@index([isEnabled])
  @@index([provider])
}

model ai_default_provider {
  id        String   @id
  provider  String   @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model ai_usage_logs {
  id             String   @id
  provider       String   @db.VarChar(50)
  model          String   @db.VarChar(100)
  operation      String   @db.VarChar(100)
  inputTokens    Int?
  outputTokens   Int?
  totalTokens    Int?
  estimatedCost  Decimal? @db.Decimal(10, 6)
  processingTime Int?
  status         String   @default("success")
  errorMessage   String?
  documentId     String?
  contractId     String?
  createdAt      DateTime @default(now())

  @@index([createdAt])
  @@index([operation])
  @@index([provider])
  @@index([status])
}

model contract_analyses {
  id                 String    @id
  contractId         String    @unique
  expirationDate     String?
  renewalTerms       String?
  sla                String?
  paymentTerms       String?
  noticePeriod       String?
  keyContacts        String?
  scopeSummary       String?
  terminationClauses String?
  confidenceScores   Json      @default("{}")
  analyzedAt         DateTime  @default(now())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  contracts          contracts @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([analyzedAt])
  @@index([contractId])
}

model contract_tags {
  contractId String
  tagId      String
  createdAt  DateTime  @default(now())
  contracts  contracts @relation(fields: [contractId], references: [id], onDelete: Cascade)
  tags       tags      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contractId, tagId])
  @@index([contractId])
  @@index([tagId])
}

model contracts {
  id                 String             @id
  vendorId           String
  title              String
  startDate          DateTime           @db.Date
  endDate            DateTime           @db.Date
  value              Decimal            @db.Decimal(14, 2)
  currency           String             @default("GBP") @db.VarChar(3)
  status             ContractStatus     @default(draft)
  documentUrl        String?
  documentKey        String?
  documentName       String?
  documentSize       Int?
  documentType       String?
  documentUploadedAt DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  documentData       Bytes?
  storageType        String?
  contract_analyses  contract_analyses?
  contract_tags      contract_tags[]
  vendors            Vendor             @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([endDate])
  @@index([startDate])
  @@index([status])
  @@index([title])
  @@index([vendorId])
}

model email_configs {
  id                String    @id
  host              String    @db.VarChar(255)
  port              Int
  secure            Boolean   @default(true)
  encryptedUsername String
  encryptedPassword String
  fromAddress       String    @db.VarChar(255)
  fromName          String?   @db.VarChar(255)
  replyTo           String?   @db.VarChar(255)
  isEnabled         Boolean   @default(true)
  lastTestedAt      DateTime?
  lastTestStatus    String?   @db.VarChar(20)
  lastTestMessage   String?
  usageCount        Int       @default(0)
  lastUsedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
}

model email_logs {
  id           String   @id
  recipient    String   @db.VarChar(255)
  subject      String   @db.VarChar(500)
  status       String   @db.VarChar(20)
  errorMessage String?
  messageId    String?  @db.VarChar(255)
  userId       String?
  module       String?  @db.VarChar(100)
  emailType    String?  @db.VarChar(50)
  metadata     Json?
  sentAt       DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([emailType])
  @@index([recipient])
  @@index([sentAt])
  @@index([status])
  @@index([userId])
}

model email_rate_limits {
  id          String   @id
  identifier  String   @unique @db.VarChar(255)
  count       Int      @default(0)
  windowStart DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([identifier])
  @@index([windowStart])
}

model exchange_rates {
  id           String   @id
  fromCurrency String   @db.VarChar(3)
  toCurrency   String   @db.VarChar(3)
  rate         Decimal  @db.Decimal(12, 6)
  lastUpdated  DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@unique([fromCurrency, toCurrency])
  @@index([fromCurrency])
  @@index([lastUpdated])
  @@index([toCurrency])
}

model invoice_tags {
  invoiceId String
  tagId     String
  createdAt DateTime @default(now())
  invoices  invoices @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tags      tags     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([invoiceId, tagId])
  @@index([invoiceId])
  @@index([tagId])
}

model invoices {
  id                 String         @id
  vendorId           String
  invoiceNumber      String         @unique
  invoiceDate        DateTime       @db.Date
  billingPeriodStart DateTime       @db.Date
  billingPeriodEnd   DateTime       @db.Date
  amount             Decimal        @db.Decimal(14, 2)
  currency           String         @default("GBP") @db.VarChar(3)
  status             InvoiceStatus  @default(pending)
  expectedAmount     Decimal?       @db.Decimal(14, 2)
  discrepancy        Decimal?       @db.Decimal(14, 2)
  toleranceThreshold Decimal?       @db.Decimal(5, 2)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime
  invoice_tags       invoice_tags[]
  vendors            Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([billingPeriodEnd])
  @@index([billingPeriodStart])
  @@index([invoiceDate])
  @@index([invoiceNumber])
  @@index([status])
  @@index([vendorId])
}

model password_reset_tokens {
  id        String    @id
  userId    String
  token     String    @unique
  type      String    @db.VarChar(20)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  users     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([type])
  @@index([userId])
}

model permission_groups {
  id                   String                 @id
  name                 String                 @unique
  description          String?
  isSystem             Boolean                @default(false)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  resource_permissions resource_permissions[]
  user_groups          user_groups[]

  @@index([isSystem])
  @@index([name])
}

model protectable_resources {
  id                   String                 @id
  resourceKey          String                 @unique
  type                 String                 @db.VarChar(20)
  name                 String
  description          String?
  parentKey            String?
  path                 String?
  sortOrder            Int                    @default(0)
  isActive             Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  resource_permissions resource_permissions[]

  @@index([isActive])
  @@index([parentKey])
  @@index([resourceKey])
  @@index([type])
}

model rate_cards {
  id            String    @id
  vendorId      String
  roleId        String
  rate          Decimal   @db.Decimal(12, 2)
  currency      String    @default("GBP") @db.VarChar(3)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  roles         roles     @relation(fields: [roleId], references: [id])
  vendors       Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, roleId, effectiveFrom])
  @@index([currency])
  @@index([effectiveFrom])
  @@index([effectiveTo])
  @@index([roleId])
  @@index([vendorId])
}

model resource_permissions {
  id                    String                @id
  resourceId            String
  groupId               String
  createdAt             DateTime              @default(now())
  permission_groups     permission_groups     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  protectable_resources protectable_resources @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, groupId])
  @@index([groupId])
  @@index([resourceId])
}

model roles {
  id           String         @id
  name         String         @unique
  description  String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  rate_cards   rate_cards[]
  team_members team_members[]

  @@index([name])
}

model system_settings {
  id          String   @id
  category    String   @db.VarChar(50)
  key         String   @db.VarChar(100)
  value       String
  description String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@unique([category, key])
  @@index([category])
  @@index([key])
}

model tags {
  id               String             @id
  name             String             @unique
  color            String?            @db.VarChar(7)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  contract_tags    contract_tags[]
  invoice_tags     invoice_tags[]
  team_member_tags team_member_tags[]
  vendor_tags      vendor_tags[]

  @@index([name])
}

model team_member_tags {
  teamMemberId String
  tagId        String
  createdAt    DateTime     @default(now())
  tags         tags         @relation(fields: [tagId], references: [id], onDelete: Cascade)
  team_members team_members @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@id([teamMemberId, tagId])
  @@index([tagId])
  @@index([teamMemberId])
}

model team_members {
  id                 String              @id
  firstName          String
  lastName           String
  email              String              @unique
  vendorId           String
  roleId             String
  dailyRate          Decimal             @db.Decimal(12, 2)
  currency           String              @default("GBP") @db.VarChar(3)
  startDate          DateTime
  endDate            DateTime?
  status             TeamMemberStatus    @default(active)
  plannedUtilization Decimal?            @db.Decimal(5, 2)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  team_member_tags   team_member_tags[]
  roles              roles               @relation(fields: [roleId], references: [id])
  vendors            Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  timesheet_entries  timesheet_entries[]

  @@index([email])
  @@index([endDate])
  @@index([roleId])
  @@index([startDate])
  @@index([status])
  @@index([vendorId])
}

model timesheet_entries {
  id           String       @id
  teamMemberId String
  date         DateTime     @db.Date
  hours        Decimal?     @db.Decimal(4, 2)
  timeOffCode  TimeOffCode?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  team_members team_members @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, date])
  @@index([date])
  @@index([teamMemberId])
  @@index([timeOffCode])
}

model user_groups {
  userId            String
  groupId           String
  createdAt         DateTime          @default(now())
  permission_groups permission_groups @relation(fields: [groupId], references: [id], onDelete: Cascade)
  users             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, groupId])
  @@index([groupId])
  @@index([userId])
}

model vendor_document_analyses {
  id                   String           @id
  documentId           String           @unique
  contractCreationDate String?
  expiryRenewalDate    String?
  involvedEntities     String?
  slaDetails           String?
  uptimeGuarantee      String?
  responseTime         String?
  scopeOfWork          String?
  termsAndConditions   String?
  terminationClauses   String?
  commercialTerms      String?
  paymentSchedule      String?
  totalValue           String?
  currency             String?
  noticePeriod         String?
  renewalTerms         String?
  keyContacts          String?
  summary              String?
  confidenceScores     Json             @default("{}")
  aiProvider           String?
  aiModel              String?
  processingTimeMs     Int?
  analyzedAt           DateTime         @default(now())
  createdAt            DateTime         @default(now())
  updatedAt            DateTime
  vendor_documents     vendor_documents @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([analyzedAt])
  @@index([documentId])
}

model vendor_documents {
  id                       String                    @id
  vendorId                 String
  documentType             DocumentType              @default(OTHER)
  title                    String?
  description              String?
  documentKey              String?
  documentName             String
  documentSize             Int
  documentMimeType         String
  enableAiExtraction       Boolean                   @default(true)
  extractionStatus         String?
  extractionError          String?
  documentDate             DateTime?                 @db.Date
  expiryDate               DateTime?                 @db.Date
  uploadedAt               DateTime                  @default(now())
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime
  documentData             Bytes?
  storageType              String                    @default("database")
  vendor_document_analyses vendor_document_analyses?
  vendors                  Vendor                    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([documentType])
  @@index([expiryDate])
  @@index([storageType])
  @@index([uploadedAt])
  @@index([vendorId])
}

model vendor_tags {
  vendorId  String
  tagId     String
  createdAt DateTime @default(now())
  tags      tags     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  vendors   Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@id([vendorId, tagId])
  @@index([tagId])
  @@index([vendorId])
}

enum ContractStatus {
  draft
  active
  expired
  terminated
}

enum DocumentType {
  CONTRACT
  SOW
  SLA
  NDA
  MSA
  AMENDMENT
  ADDENDUM
  INVOICE
  PROPOSAL
  INSURANCE
  COMPLIANCE
  OTHER
}

enum InvoiceStatus {
  pending
  validated
  disputed
  paid
}

enum PermissionLevel {
  denied
  view
  write
  admin
}

enum TeamMemberStatus {
  active
  inactive
  onboarding
  offboarded
}

enum TimeOffCode {
  VAC
  HALF
  SICK
  MAT
  CAS
  UNPAID
}

enum VendorStatus {
  active
  inactive
}
